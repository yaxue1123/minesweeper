<!DOCTYPE html>
<html>
<head>
    <title>Minesweeper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="Shortcut Icon" href="mine.jpg">
    <link rel='stylesheet' href='style.css'/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <header>
        <img src="mine.jpg" class = "head-pic">
        <h1>Minesweeper</h1>
    </header>
    <nav>
        <ul>
            <li><a>Game</a></li>
            <li><a>Option</a></li>
            <li><a>Help</a></li>
        </ul>
    </nav>
    <section>
        <div id = "minefield">

        </div>
    </section>
    <footer>
        Copyright Yaxue Guo 2018
    </footer>
    <script>
        // Disable context menu on the page completely.
        $(document).contextmenu(function() {
            return true;
        });

        // Decide the size of mine.
        let height = 8;
        let width = 8;

        // Randomly creates the number of bombs.
        // The number of mines should be at least 1 and at most the size of the minefield-1.
        // In this case use random num, can also use fixed number based on difficulty level.
        let total_bomb = 8; //Math.floor(Math.random() * (height * width - 1) + 1);

        let mine = new Mine(height, width, total_bomb);
        
        let minefield = mine.createMine();

        let userFoundBomb = 0;

        let userMarked = 0;

        // Draw the mine field with buttons.
        function drawMine(){
            // Draw the mine using buttons.
            // Set each button with id i-j to refer to the location in the 2d array. 
            for(let i = 1; i <= height; i++){
                $("#minefield").append("<div>");
                for (let j = 1; j <= width; j++){
                    $("#minefield").append("<button x = " + i + " y = " + j + 
                    " hasBomb = " + minefield[i][j] + " id = " + i + "-" + j + 
                    " clicked = 0" + ">" + "</button>");
                }
                $("#minefield").append("</div>");
            }
        }

        drawMine();

        // Calculate how many surrounding bombs.
        // Input: int i and j. i ranges from [1, height], j ranges from [1, width].
        function countBomb(i, j) {
            return minefield[i-1][j-1] + minefield[i-1][j] + minefield[i-1][j+1] +
                    minefield[i][j-1] + minefield[i][j+1] +
                    minefield[i+1][j-1] + minefield[i+1][j] + minefield[i+1][j+1];

        }

        // When a field's bomb count is 0, then unreveal the 8 fields around it. 
        // Iterate until all the neighbors have non-zero bomb count.
        function unreveal_neighbor(x, y) {

        }
     
        // Input: the id of button.
        function clickButton(id) {
            let cur_button = $("#"+id);

            cur_button.css("background-color", "white");
            cur_button.attr("clicked", 1);

            if(parseInt(cur_button.attr("hasBomb")) === 1){
                alert("Bomb!!!");
                location.reload();
            } else {
                // See if surrounding has bomb.
                let x = parseInt(cur_button.attr("x"));
                let y = parseInt(cur_button.attr("y"));
                let count = countBomb(x, y);
                if (count !== 0) {
                    cur_button.html("<a class = 'bomb_count'>" + count + "</a>");
                } else {
                    // If the current field has no bomb, then explore the adjacent ones (8 at max).
                    // Keep exploring until find bomb.
                    cur_button.text("");
                    // Traverse all adjacent field.
                    for (let i = x - 1; i <= x + 1; i++) {
                        for (let j = y - 1; j <= y + 1; j++) {
                            // Generate button id.
                            let adj_id = i + "-" + j;
                            console.log(adj_id + " " + $("#"+adj_id).attr("clicked"));
                            // Fake click on unclicked ones.
                            if ($("#"+adj_id).attr("clicked") === '0') {
                                clickButton(adj_id);
                            }
                        }
                    }
                }
            }

        }

        $("button").click(function() {
            clickButton($(this).attr("id"));
        });
            
        // User can right click to mark bomb.
        // User wins when marking all bombs.
        $("button").mousedown(function(e) {
            // If user right clicks.
            if (e.which === 3) {
                // Limit the mark number within the total bomb number's range.
                if (userMarked > total_bomb) {
                    alert("Exceed bomb num!")
                }
                else 
                {
                    $(this).text("X");
                    userMarked += 1; 
                }
                // If the user marks is bomb, record this.
                if ($(this).attr("hasBomb") === "1") {
                    userFoundBomb += 1;
                    console.log("found bomb:" + userFoundBomb);
                }
                // If user found all bombs, win!
                if (userFoundBomb === total_bomb) {
                    alert("You win!")
                }
            }
        });

    </script>
</body>
</html>
